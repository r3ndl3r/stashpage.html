<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stashpage Dasboard</title>
    <!-- Tailwind CSS for utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Base Body and Background Styling --- */
        body {
            /* Fallback for older browsers */
            background-color: #1a202c; 
            /* Layered radial gradients to create the colorful, blurry effect */
            background-image: 
                radial-gradient(at 0% 0%, rgba(129, 140, 248, 0.4) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(250, 204, 21, 0.3) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(239, 68, 68, 0.4) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(34, 197, 94, 0.3) 0px, transparent 50%);
            
            /* Animation properties */
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;

            /* Original properties to keep */
            background-position: center;
            background-attachment: fixed;
            overflow-x: hidden;
        }

        /* Keyframes for the animation */
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Dashboard Card Styling --- */
        .card-window {
            position: absolute; /* Allows for drag-and-drop positioning */
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px); /* Frosted glass effect */
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 280px;
        }

        /* --- Individual App Tile Styling --- */
        .app-tile {
            background-color: rgba(30, 41, 59, 0.7);
            transition: all 0.2s ease-in-out;
        }
        .app-tile:hover {
            background-color: rgba(51, 65, 85, 0.9);
            transform: translateY(-2px); /* Slight lift effect on hover */
        }
        .app-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        
        /* --- Edit Mode Specific Styling --- */
        .drag-handle {
            cursor: move; /* Indicates that the element is draggable */
        }

        /* --- Modal Styling (for Edit, Confirm, and Settings) --- */
        #modal, #settings-modal {
            display: none; /* Modals are hidden by default */
        }
        #modal.is-visible, #settings-modal.is-visible {
            display: flex; /* Use flexbox to center the modal content */
        }

        /* --- Add/Edit Drawer Styling --- */
        .controls-container {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%); /* Start off-screen */
        }
        .controls-container.is-visible {
            transform: translateY(0); /* Slide into view */
        }
        .add-controls-tab {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 0.5rem 1.5rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            cursor: pointer;
            z-index: 100;
            transition: opacity 0.3s;
        }
        .add-controls-tab.hidden {
            opacity: 0;
            pointer-events: none; /* Prevent clicking when hidden */
        }
        
        /* --- Responsive Styling for Mobile Devices --- */
        @media (max-width: 768px) {
            body {
                overflow-y: auto; /* Allow vertical scrolling on small screens */
            }
            #dashboard-canvas {
                position: relative !important;
                height: auto !important;
                padding-top: 1rem;
                padding-bottom: 80px; /* Space for controls */
            }
            /* Stack cards vertically on mobile */
            .card-window {
                position: relative !important;
                left: auto !important;
                top: auto !important;
                width: 100%;
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body class="text-gray-200 font-sans">

    <!-- Main container where app cards are dynamically rendered -->
    <div id="dashboard-canvas" class="relative w-full h-screen"></div>
    
    <!-- Settings button (cog icon) in the top-right corner -->
    <div class="fixed top-4 right-4 z-50">
        <button onclick="toggleSettingsModal(true)" class="text-white hover:text-gray-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>

    <!-- Container for buttons visible in 'View Mode' -->
    <div id="view-controls" class="fixed bottom-6 right-6 z-50">
        <!-- Button to enter Edit Mode -->
        <button onclick="toggleEditMode(true)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-4 rounded-full shadow-lg transition-transform duration-200 hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" /></svg>
        </button>
    </div>
    
    <!-- Tab to open the Add/Edit drawer, visible only in Edit Mode -->
    <div id="show-controls-tab" onclick="toggleAddControls(true)" class="add-controls-tab text-white hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
    </div>

    <!-- The main drawer/panel for adding new apps and categories -->
    <div class="fixed bottom-0 left-0 right-0 z-40">
        <div class="controls-container p-4 mx-auto max-w-4xl rounded-t-lg shadow-lg relative">
            <!-- Close button for the drawer -->
            <button type="button" onclick="toggleAddControls(false)" class="absolute top-3 right-3 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <!-- Grid layout for the two main forms -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Form for adding a new app -->
                <div>
                    <h4 class="text-lg font-semibold text-white mb-2">Add New App</h4>
                    <div class="space-y-2">
                        <input type="text" id="new-app-name" placeholder="App Name" class="w-full p-2 rounded-md text-sm bg-gray-700 text-white border border-gray-600">
                        <input type="text" id="new-app-url" placeholder="App URL" class="w-full p-2 rounded-md text-sm bg-gray-700 text-white border border-gray-600">
                        <input type="text" id="new-app-icon" placeholder="Icon URL" class="w-full p-2 rounded-md text-sm bg-gray-700 text-white border border-gray-600">
                        <select id="new-app-category" class="w-full p-2 rounded-md text-sm bg-gray-700 text-white border border-gray-600"></select>
                        <button type="button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" onclick="addApp()">Add App</button>
                    </div>
                </div>
                <!-- Form for adding a new category -->
                <div>
                    <h4 class="text-lg font-semibold text-white mb-2">Add New Category</h4>
                    <div class="space-y-2">
                        <input type="text" id="new-category-name" placeholder="Category Name" class="w-full p-2 rounded-md text-sm bg-gray-700 text-white border border-gray-600">
                        <button type="button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" onclick="addCategory()">Add Category</button>
                    </div>
                     <!-- Action buttons for the entire edit session -->
                     <div class="flex justify-end mt-4 space-x-2">
                        <button type="button" onclick="toggleEditMode(false)" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button type="button" onclick="saveAndExitEditMode()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Save & Exit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for Settings (Import/Export) -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm shadow-lg relative">
            <button onclick="toggleSettingsModal(false)" class="absolute top-3 right-3 text-gray-400 hover:text-white">&times;</button>
            <h3 class="text-xl text-white mb-4">Settings</h3>
            <div class="space-y-4">
                <button onclick="exportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Export Data</button>
                <button onclick="triggerImport()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Import Data</button>
                <!-- Hidden file input used to trigger the file selection dialog -->
                <input type="file" id="import-file-input" class="hidden" accept=".json" onchange="importData(event)">
            </div>
        </div>
    </div>

    <!-- Generic modal for alerts, confirmations, and editing items -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm shadow-lg" id="modal-content"></div>
    </div>

    <script>
        // --- Global State Variables ---
        let dashboardData = []; // Main array holding all categories and apps
        let isEditMode = false; // Toggles between view and edit functionality
        let activeCard = null; // The card currently being dragged
        let offsetX, offsetY; // Offsets for smooth dragging
        let confirmCallback = null; // Stores the callback function for confirmation modals
        let currentEditElement = null; // Stores the element being edited in a modal

        // --- Default Data for First-Time Use ---
        const defaultData = [
            {
                "title": "Virtualization", "x": 50, "y": 50,
                "apps": [
                    { "name": "Proxmox", "url": "http://192.168.1.10:8006", "icon": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/proxmox.png" }
                ]
            },
            {
                "title": "Networking", "x": 350, "y": 50,
                "apps": [
                    { "name": "Pi-hole", "url": "http://192.168.1.11/admin", "icon": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/pi-hole.png" },
                    { "name": "OPNsense", "url": "https://192.168.1.1", "icon": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/opnsense.png" }
                ]
            },
            {
                "title": "Monitoring", "x": 50, "y": 250,
                "apps": [
                    { "name": "Uptime Kuma", "url": "http://192.168.1.12:3001", "icon": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/uptime-kuma.png" },
                    { "name": "Grafana", "url": "http://192.168.1.13:3000", "icon": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/grafana.png" }
                ]
            },
            {
                "title": "Containers", "x": 350, "y": 250,
                "apps": [
                    { "name": "Portainer", "url": "http://192.168.1.14:9000", "icon": "https://cdn.jsdelivr.net/gh/walkxcode/dashboard-icons/png/portainer.png" }
                ]
            }
        ];
        
        // --- Data Persistence Functions ---

        /**
         * Loads the dashboard layout from the browser's localStorage.
         * If no data is found, it loads the default sample data.
         */
        function loadDataFromLocalStorage() {
            const data = localStorage.getItem('appsDashboardData');
            dashboardData = data ? JSON.parse(data) : defaultData;
        }

        /**
         * Scans the current state of the DOM and saves it to localStorage.
         * This function is called when exiting edit mode.
         */
        function saveDataToLocalStorage() {
            const categories = [];
            document.querySelectorAll('#dashboard-canvas .card-window').forEach(card => {
                const category = {
                    title: card.dataset.categoryTitle,
                    x: parseInt(card.style.left, 10) || 0,
                    y: parseInt(card.style.top, 10) || 0,
                    apps: []
                };
                card.querySelectorAll('.app-tile').forEach(tile => {
                    category.apps.push({
                        name: tile.dataset.name,
                        url: tile.dataset.url,
                        icon: tile.dataset.icon
                    });
                });
                categories.push(category);
            });
            localStorage.setItem('appsDashboardData', JSON.stringify(categories));
            dashboardData = categories; // Update the global state
        }
        
        // --- Core Rendering and UI Functions ---

        /**
         * The main function to render the entire dashboard.
         * It clears the canvas and rebuilds it based on the `dashboardData` array and `isEditMode` state.
         */
        function renderDashboard() {
            const canvas = document.getElementById('dashboard-canvas');
            canvas.innerHTML = '';

            dashboardData.forEach(category => {
                const card = document.createElement('div');
                card.className = 'card-window rounded-lg p-4 shadow-lg flex flex-col';
                card.dataset.categoryTitle = category.title;
                card.style.left = `${category.x || 0}px`;
                card.style.top = `${category.y || 0}px`;

                // Conditionally add edit controls for the category header
                let editControls = '';
                if (isEditMode) {
                    editControls = `
                        <div class="flex items-center space-x-2">
                            <button type="button" class="text-blue-400 hover:text-blue-300" onclick="openEditModal(this, 'category')">&#9998;</button>
                            <button type="button" class="text-red-400 hover:text-red-300" onclick="deleteCategory(this)">&times;</button>
                        </div>`;
                }
                
                const handleClass = isEditMode ? 'drag-handle' : '';
                card.innerHTML = `
                    <div class="${handleClass} flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                        <h2 class="text-xl font-bold text-white">${category.title}</h2>
                        ${editControls}
                    </div>
                    <div class="app-list flex flex-col space-y-2 flex-grow"></div>`;
                
                // Render the apps within the category
                const appList = card.querySelector('.app-list');
                category.apps.forEach(app => {
                    // App tiles are links in view mode, and divs in edit mode
                    const appTile = document.createElement(isEditMode ? 'div' : 'a');
                    appTile.className = 'app-tile flex items-center p-3 rounded-md shadow-sm';
                    
                    if (!isEditMode) {
                        appTile.href = app.url;
                        appTile.target = "_blank";
                    }

                    appTile.dataset.name = app.name;
                    appTile.dataset.url = app.url;
                    appTile.dataset.icon = app.icon;

                    // Conditionally add edit controls for each app
                    let appEditControls = '';
                    if (isEditMode) {
                        appEditControls = `
                            <div class="flex items-center ml-auto">
                                <button type="button" class="text-gray-400 hover:text-gray-300 px-1" onclick="moveAppUp(this)">&#x25B2;</button>
                                <button type="button" class="text-gray-400 hover:text-gray-300 px-1" onclick="moveAppDown(this)">&#x25BC;</button>
                                <button type="button" class="text-blue-400 hover:text-blue-300 px-1" onclick="openEditModal(this, 'app')">&#9998;</button>
                                <button type="button" class="text-red-400 hover:text-red-300 px-1" onclick="deleteApp(this)">&times;</button>
                            </div>`;
                    }

                    appTile.innerHTML = `
                        ${app.icon ? `<img src="${app.icon}" class="app-icon mr-3">` : ''}
                        <span class="font-semibold text-white flex-grow">${app.name}</span>
                        ${appEditControls}
                    `;
                    appList.appendChild(appTile);
                });

                canvas.appendChild(card);
                if (isEditMode) {
                    makeDraggable(card); // Enable dragging only in edit mode
                }
            });
        }

        /**
         * Toggles between view and edit modes and re-renders the dashboard.
         * @param {boolean} edit - True to enter edit mode, false to exit.
         */
        function toggleEditMode(edit) {
            isEditMode = edit;
            document.getElementById('view-controls').classList.toggle('hidden', edit);
            document.getElementById('show-controls-tab').classList.toggle('hidden', !edit);
            if (!edit) {
                toggleAddControls(false); // Ensure drawer is closed when exiting edit mode
            }
            renderDashboard();
        }
        
        /**
         * Saves the current layout and exits edit mode.
         */
        function saveAndExitEditMode() {
            saveDataToLocalStorage();
            toggleEditMode(false);
        }
        
        /**
         * Shows or hides the slide-up drawer for adding new items.
         * @param {boolean} show - True to show the drawer, false to hide it.
         */
        function toggleAddControls(show) {
            const formContainer = document.querySelector('.controls-container');
            const showTab = document.getElementById('show-controls-tab');
            if (show) {
                updateCategoryDropdown();
                formContainer.classList.add('is-visible');
                showTab.classList.add('hidden');
            } else {
                formContainer.classList.remove('is-visible');
                showTab.classList.remove('hidden');
            }
        }

        // --- Drag and Drop Functionality ---

        /**
         * Attaches mousedown event listeners to a card's drag handle.
         * @param {HTMLElement} card - The card element to make draggable.
         */
        function makeDraggable(card) {
            const handle = card.querySelector('.drag-handle');
            if (!handle) return;
            handle.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'BUTTON') return; // Prevent dragging when clicking buttons
                e.preventDefault();
                activeCard = card;
                offsetX = e.clientX - activeCard.offsetLeft;
                offsetY = e.clientY - activeCard.offsetTop;
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
            });
        }

        /**
         * Handles the mousemove event to update the card's position.
         * @param {MouseEvent} e - The mouse event.
         */
        function drag(e) {
            if (!activeCard) return;
            e.preventDefault();
            activeCard.style.left = `${e.clientX - offsetX}px`;
            activeCard.style.top = `${e.clientY - offsetY}px`;
        }

        /**
         * Cleans up drag-and-drop event listeners on mouseup.
         */
        function stopDrag() {
            activeCard = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
        }
        
        // --- CRUD (Create, Read, Update, Delete) Operations ---

        function updatePositionsInData() {
            document.querySelectorAll('#dashboard-canvas .card-window').forEach(card => {
                const title = card.dataset.categoryTitle;
                const category = dashboardData.find(c => c.title === title);
                if (category) {
                    category.x = parseInt(card.style.left, 10) || 0;
                    category.y = parseInt(card.style.top, 10) || 0;
                }
            });
        }
        
        /**
         * Populates the category dropdown in the "Add App" form.
         */
        function updateCategoryDropdown() {
            const select = document.getElementById('new-app-category');
            select.innerHTML = '';
            document.querySelectorAll('.card-window').forEach(card => {
                const title = card.dataset.categoryTitle;
                const option = document.createElement('option');
                option.value = title;
                option.textContent = title;
                select.appendChild(option);
            });
        }

        /**
         * Adds a new app to the selected category in the `dashboardData` array and re-renders.
         */
        function addApp() {
            updatePositionsInData();
            const name = document.getElementById('new-app-name').value.trim();
            const url = document.getElementById('new-app-url').value.trim();
            const icon = document.getElementById('new-app-icon').value.trim();
            const categoryTitle = document.getElementById('new-app-category').value;
            if (!name || !url || !categoryTitle) {
                showAlert('App Name, URL, and Category are required.');
                return;
            }
            const category = dashboardData.find(c => c.title === categoryTitle);
            if(category) {
                category.apps.push({ name, url, icon });
                renderDashboard(); // Re-render to show the new app
            }
            // Clear input fields
            document.getElementById('new-app-name').value = '';
            document.getElementById('new-app-url').value = '';
            document.getElementById('new-app-icon').value = '';
        }

        /**
         * Adds a new category to the `dashboardData` array and re-renders.
         */
        function addCategory() {
            updatePositionsInData();
            const name = document.getElementById('new-category-name').value.trim();
            if (!name) {
                showAlert('Category name is required.');
                return;
            }
            if (dashboardData.some(c => c.title === name)) {
                showAlert('Category with this name already exists.');
                return;
            }
            dashboardData.push({ title: name, x: 20, y: 20, apps: [] });
            renderDashboard();
            updateCategoryDropdown();
            document.getElementById('new-category-name').value = '';
        }

        /**
         * Opens the edit modal with a form for either an app or a category.
         * @param {HTMLElement} btn - The button element that was clicked.
         * @param {string} type - The type of item to edit ('app' or 'category').
         */
        function openEditModal(btn, type) {
            const modalContent = document.getElementById('modal-content');
            if (type === 'app') {
                currentEditElement = btn.closest('.app-tile');
                const { name, url, icon } = currentEditElement.dataset;
                modalContent.innerHTML = `
                    <h3 class="text-xl text-white mb-4">Edit App</h3>
                    <input type="text" id="edit-app-name" value="${name}" class="w-full p-2 rounded-md text-sm bg-gray-700 mb-2">
                    <input type="text" id="edit-app-url" value="${url}" class="w-full p-2 rounded-md text-sm bg-gray-700 mb-2">
                    <input type="text" id="edit-app-icon" value="${icon}" class="w-full p-2 rounded-md text-sm bg-gray-700 mb-2">
                    <div class="flex justify-end mt-4 space-x-2">
                        <button type="button" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded" onclick="closeModal()">Cancel</button>
                        <button type="button" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded" onclick="saveAppChanges()">Save</button>
                    </div>`;
            } else { // category
                currentEditElement = btn.closest('.card-window');
                const title = currentEditElement.dataset.categoryTitle;
                modalContent.innerHTML = `
                    <h3 class="text-xl text-white mb-4">Edit Category</h3>
                    <input type="text" id="edit-category-title" value="${title}" class="w-full p-2 rounded-md text-sm bg-gray-700 mb-2">
                    <div class="flex justify-end mt-4 space-x-2">
                        <button type="button" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded" onclick="closeModal()">Cancel</button>
                        <button type="button" class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded" onclick="saveCategoryChanges()">Save</button>
                    </div>`;
            }
            document.getElementById('modal').classList.add('is-visible');
        }

        /**
         * Saves changes from the "Edit App" modal to the `dashboardData` array.
         */
        function saveAppChanges() {
            updatePositionsInData();
            const newName = document.getElementById('edit-app-name').value.trim();
            const newUrl = document.getElementById('edit-app-url').value.trim();
            const newIcon = document.getElementById('edit-app-icon').value.trim();
            if (!newName || !newUrl) return showAlert('App Name and URL are required.');
    
            const oldName = currentEditElement.dataset.name;
            const categoryTitle = currentEditElement.closest('.card-window').dataset.categoryTitle;
            const category = dashboardData.find(c => c.title === categoryTitle);
            const app = category.apps.find(a => a.name === oldName);
            if (app) {
                app.name = newName;
                app.url = newUrl;
                app.icon = newIcon;
            }
            closeModal();
            renderDashboard();
        }

        /**
         * Saves changes from the "Edit Category" modal to the `dashboardData` array.
         */
        function saveCategoryChanges() {
            updatePositionsInData();
            const newTitle = document.getElementById('edit-category-title').value.trim();
            if (!newTitle) return showAlert('Category title is required.');
            const oldTitle = currentEditElement.dataset.categoryTitle;
            const category = dashboardData.find(c => c.title === oldTitle);
            if (category) {
                category.title = newTitle;
            }
            closeModal();
            renderDashboard();
        }

        /**
         * Deletes an app after confirmation.
         */
        function deleteApp(btn) {
            showConfirm('Delete this app?', confirmed => {
                if (confirmed) {
                    updatePositionsInData();
                    const appName = btn.closest('.app-tile').dataset.name;
                    const categoryTitle = btn.closest('.card-window').dataset.categoryTitle;
                    const category = dashboardData.find(c => c.title === categoryTitle);
                    if (category) {
                        category.apps = category.apps.filter(a => a.name !== appName);
                        renderDashboard();
                    }
                }
            });
        }

        /**
         * Deletes a category and all its apps after confirmation.
         */
        function deleteCategory(btn) {
            showConfirm('Delete this entire category?', confirmed => {
                if (confirmed) {
                    updatePositionsInData();
                    const categoryTitle = btn.closest('.card-window').dataset.categoryTitle;
                    dashboardData = dashboardData.filter(c => c.title !== categoryTitle);
                    renderDashboard();
                }
            });
        }

        /**
         * Moves an app up one position in its category's list.
         */
        function moveAppUp(btn) {
            updatePositionsInData();
            const appTile = btn.closest('.app-tile');
            const appName = appTile.dataset.name;
            const categoryTitle = appTile.closest('.card-window').dataset.categoryTitle;
            const category = dashboardData.find(c => c.title === categoryTitle);
            const index = category.apps.findIndex(a => a.name === appName);
            if (index > 0) {
                // Swap elements in the array
                [category.apps[index], category.apps[index - 1]] = [category.apps[index - 1], category.apps[index]];
                renderDashboard();
            }
        }

        /**
         * Moves an app down one position in its category's list.
         */
        function moveAppDown(btn) {
            updatePositionsInData();
            const appTile = btn.closest('.app-tile');
            const appName = appTile.dataset.name;
            const categoryTitle = appTile.closest('.card-window').dataset.categoryTitle;
            const category = dashboardData.find(c => c.title === categoryTitle);
            const index = category.apps.findIndex(a => a.name === appName);
            if (index < category.apps.length - 1) {
                // Swap elements in the array
                [category.apps[index], category.apps[index + 1]] = [category.apps[index + 1], category.apps[index]];
                renderDashboard();
            }
        }

        // --- Generic Modal Functions ---

        /**
         * Displays a simple alert modal with an OK button.
         * @param {string} message - The message to display.
         */        
        function showAlert(message) {
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `<p class="text-white mb-4">${message}</p><div class="flex justify-end"><button type="button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded" onclick="closeModal()">OK</button></div>`;
            document.getElementById('modal').classList.add('is-visible');
        }

        /**
         * Displays a confirmation modal with OK and Cancel buttons.
         * @param {string} message - The confirmation message.
         * @param {function} callback - The function to call with `true` if OK is clicked.
         */
        function showConfirm(message, callback) {
            confirmCallback = callback;
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = `<p class="text-white mb-4">${message}</p><div class="flex justify-end space-x-2"><button type="button" class="bg-gray-500 hover:bg-gray-600 px-4 py-2 rounded" onclick="closeModal()">Cancel</button><button type="button" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded" onclick="handleConfirm()">OK</button></div>`;
            document.getElementById('modal').classList.add('is-visible');
        }

        /**
         * Closes any active generic modal and resets state.
         */
        function closeModal() {
            document.getElementById('modal').classList.remove('is-visible');
            currentEditElement = null;
            confirmCallback = null;
        }

        /**
         * Handles the OK click in a confirmation modal.
         */
        function handleConfirm() {
            if (confirmCallback) confirmCallback(true);
            closeModal();
        }

        // --- Settings (Import/Export) Functions ---

        /**
         * Shows or hides the settings modal.
         * @param {boolean} show - True to show, false to hide.
         */
        function toggleSettingsModal(show) {
            document.getElementById('settings-modal').classList.toggle('is-visible', show);
        }

        /**
         * Exports the current dashboard data to a JSON file.
         */
        function exportData() {
            saveDataToLocalStorage(); 
            const data = localStorage.getItem('appsDashboardData');
            if (!data || data === '[]') {
                showAlert('No data to export.');
                return;
            }
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dashboard-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            toggleSettingsModal(false);
        }

        /**
         * Triggers the hidden file input for importing data.
         */
        function triggerImport() {
            document.getElementById('import-file-input').click();
        }

        /**
         * Handles the file import process.
         * @param {Event} event - The file input change event.
         */
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        localStorage.setItem('appsDashboardData', JSON.stringify(importedData));
                        loadDataFromLocalStorage();
                        renderDashboard();
                        toggleSettingsModal(false);
                        showAlert('Data imported successfully!');
                    } else {
                        showAlert('Invalid file format.');
                    }
                } catch (error) {
                    showAlert('Error reading the file. Please ensure it is a valid JSON file.');
                }
            };
            reader.readAsText(file);
            event.target.value = null; // Reset input for re-uploading the same file
        }

        // --- Initial Load ---

        /**
         * Attaches an event listener to run when the page content is fully loaded.
         */
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocalStorage();
            renderDashboard();
        });
     </script>
</body>
</html>